#!/bin/bash

root=/opt/google/chrome-beta
chrome="$XDG_RUNTIME_DIR"/chrome
(
	user="$chrome"/user
	cache="$chrome"/cache

# create dir tree
	if test ! -d "$chrome"
	then mkdir "$chrome"
	fi
	if test ! -d "$cache"
	then mkdir "$cache"
	fi
	if test ! -d "$user"
	then mkdir "$user"
	fi

# write default preferences
	exec chrome-mkconfig "$user"
)

export CHROME_VERSION_EXTRA=beta
export GNOME_DISABLE_CRASH_DIALOG=SET_BY_GOOGLE_CHROME

# always use chrome's libs
if test -z "$LD_LIBRARY_PATH"
then export LD_LIBRARY_PATH="$root":"$root"/lib
else export LD_LIBRARY_PATH="$root":"$root"/lib:"$LD_LIBRARY_PATH"
fi

# see http://crbug.com/376567
# note that we have bashisms below
# TODO: replace with something POSIX-compatible
# idk now how to do this in POSIX though
exec </dev/null
exec > >(exec cat)
exec 2> >(exec cat >&2)

exec "$root"/chrome \
  --disk-cache-dir="$chrome"/cache \
  --user-data-dir="$chrome"/user \
  --enable-potentially-annoying-security-features \
  --mark-non-secure-as=non-secure \
  --autoplay-policy=user-gesture-required-for-cross-origin \
  --disable-sync \
  --no-referrers \
  --no-pings \
  --site-per-process \
  --enable-experimental-fullscreen-exit-ui \
  --disable-password-generation \
  --show-saved-copy=primary \
  --google-base-url='https://ddg.gg/lite/' \
  --enable-features=OverlayScrollbar,NoScriptPreviews --enable-tab-audio-muting \
  --blink-settings=disallowFetchForDocWrittenScriptsInMainFrame=false \
  --disable-features=AppBanners,ExperimentalAppBanners,AutofillCreditCardAblationExperiment,AutofillCreditCardLastUsedDateDisplay,AutofillSendBillingCustomerNumber,AutofillUpstreamSendDetectedValues,AutofillUpstreamSendPanFirstSix,DesktopIOSPromotion,EnableUsernameCorrection,GamepadExtensions,GenericSensor,GenericSensorExtraClasses,NewUsbBackend,NoStatePrefetch,OpenVR,SafeSearchUrlReporting,SpeculativeResourcePrefetching,enable-manual-password-generation,enable-password-force-saving \
  --show-cert-link \
  --enable-quic \
  "$@"

# References:
# https://google.com/intl/en/chrome/browser/privacy/whitepaper.html
# https://thesimplecomputer.info/the-private-life-of-chromium-browsers
# https://github.com/chef-koch/chromium-hardening/blob/master/command%20line/cmd.txt
