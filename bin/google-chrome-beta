#!/bin/dash
root=/opt/google/chrome-beta
chrome="$XDG_RUNTIME_DIR"/chrome
(
	user="$chrome"/user
	cache="$chrome"/cache

	if test ! -d "$chrome"
	then mkdir "$chrome"
	fi

	if test ! -d "$cache"
	then mkdir "$cache"
	fi

	if test ! -d "$user"
	then mkdir "$user"
	fi

	exec chrome-mkconfig "$user"
)

# always use chrome's libs
if test -z "$LD_LIBRARY_PATH"
then export LD_LIBRARY_PATH="$root":"$root"/lib
else export LD_LIBRARY_PATH="$root":"$root"/lib:"$LD_LIBRARY_PATH"
fi

# see http://crbug.com/376567
exec </dev/null
# proxy stdout
if test ! -e "$chrome"/stdout
then mkfifo "$chrome"/stdout
fi
if test -p "$chrome"/stdout
then
	cat <"$chrome"/stdout &
	exec >"$chrome"/stdout
else exec >/dev/null
fi
# proxy stderr
if test ! -e "$chrome"/stderr
then mkfifo "$chrome"/stderr
fi
if test -p "$chrome"/stderr
then
	cat <"$chrome"/stderr >&2 &
	exec 2>"$chrome"/stderr
else exec 2>/dev/null
fi

CHROME_VERSION_EXTRA=beta \
GNOME_DISABLE_CRASH_DIALOG=SET_BY_GOOGLE_CHROME \
exec "$root"/chrome \
  --enable-potentially-annoying-security-features \
  --google-base-url='https://ddg.gg/lite/' \
  --disk-cache-dir="$chrome"/cache \
  --user-data-dir="$chrome"/user \
  --show-cert-link \
  --disable-sync \
  --no-referrers \
  "$@"
